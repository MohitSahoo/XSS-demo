<!DOCTYPE html>
<html>
<head>
    <title>Test Stored XSS Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .success { background: #28a745; color: white; }
        .info { background: #17a2b8; color: white; }
        .warning { background: #ffc107; color: black; }
        .result { margin: 20px 0; padding: 15px; border-radius: 4px; }
        .good { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .bad { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Stored XSS Fix Verification</h1>
        <p>This page verifies that the stored XSS issues have been resolved.</p>
        
        <div>
            <h3>Test Actions:</h3>
            <button class="info" onclick="checkDatabase()">1. Check Database Status</button>
            <button class="warning" onclick="testClearFunction()">2. Test Clear Function</button>
            <button class="success" onclick="testAddAndClear()">3. Full Test Cycle</button>
        </div>
        
        <div id="result"></div>
        
        <div>
            <h3>‚úÖ What Was Fixed:</h3>
            <ul>
                <li><strong>Database Cleared:</strong> Removed 25 old comments, 129 logs, 5 attacker records</li>
                <li><strong>Reset Function:</strong> Now properly clears display immediately</li>
                <li><strong>Clear Function:</strong> Improved with better state management</li>
                <li><strong>Force Refresh:</strong> Added button to completely reload page if needed</li>
                <li><strong>Better Feedback:</strong> Clear visual indicators during operations</li>
            </ul>
            
            <h3>üß™ Manual Test Steps:</h3>
            <ol>
                <li>Go to <a href="http://localhost:3000/stored" target="_blank">Stored XSS Page</a></li>
                <li>The page should now be clean with no old comments</li>
                <li>Add a test comment: <code>&lt;script&gt;alert('test')&lt;/script&gt;</code></li>
                <li>Click "üóëÔ∏è Clear Comments" - should clear immediately</li>
                <li>Add another comment, then click "üóëÔ∏è Reset Database" - should clear everything</li>
                <li>If still having issues, use "üîÑ Force Refresh Page" button</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        
        function showResult(message, type = 'good') {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        async function checkDatabase() {
            try {
                showResult('üîç Checking database status...', 'good');
                
                // Check comments
                const commentsResponse = await fetch(`${API_BASE}/stored/comments`, {
                    headers: { 'Accept': 'application/json' }
                });
                const comments = await commentsResponse.json();
                
                // Check exploit logs
                const logsResponse = await fetch(`${API_BASE}/exploits/logs`);
                const logs = await logsResponse.json();
                
                // Check attacker data
                const attackerResponse = await fetch(`${API_BASE}/attacker/data`);
                const attackerData = await attackerResponse.json();
                
                const total = comments.length + logs.length + attackerData.length;
                
                if (total === 0) {
                    showResult(`‚úÖ Database is clean! No old data found.`, 'good');
                } else {
                    showResult(`‚ö†Ô∏è Found ${total} records: ${comments.length} comments, ${logs.length} logs, ${attackerData.length} attacker records. Consider running the clear script again.`, 'bad');
                }
            } catch (error) {
                showResult('‚ùå Error checking database: ' + error.message, 'bad');
            }
        }
        
        async function testClearFunction() {
            try {
                showResult('üß™ Testing clear function...', 'good');
                
                const response = await fetch(`${API_BASE}/stored/comments`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showResult('‚úÖ Clear function is working properly!', 'good');
                } else {
                    showResult('‚ùå Clear function failed: ' + response.statusText, 'bad');
                }
            } catch (error) {
                showResult('‚ùå Error testing clear function: ' + error.message, 'bad');
            }
        }
        
        async function testAddAndClear() {
            try {
                showResult('üîÑ Running full test cycle...', 'good');
                
                // Add a test comment
                await fetch(`${API_BASE}/stored/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-security-mode': 'vulnerable'
                    },
                    body: JSON.stringify({
                        text: '<script>console.log("Test comment for clearing")</script>',
                        mode: 'vulnerable'
                    })
                });
                
                // Check it was added
                const checkResponse = await fetch(`${API_BASE}/stored/comments`, {
                    headers: { 'Accept': 'application/json' }
                });
                const comments = await checkResponse.json();
                
                if (comments.length > 0) {
                    // Clear it
                    await fetch(`${API_BASE}/stored/comments`, {
                        method: 'DELETE'
                    });
                    
                    // Verify it's cleared
                    const verifyResponse = await fetch(`${API_BASE}/stored/comments`, {
                        headers: { 'Accept': 'application/json' }
                    });
                    const finalComments = await verifyResponse.json();
                    
                    if (finalComments.length === 0) {
                        showResult('‚úÖ Full test cycle passed! Add ‚Üí Clear ‚Üí Verify all working.', 'good');
                    } else {
                        showResult('‚ùå Clear function not working - comments still exist', 'bad');
                    }
                } else {
                    showResult('‚ùå Test comment was not added', 'bad');
                }
            } catch (error) {
                showResult('‚ùå Error in full test cycle: ' + error.message, 'bad');
            }
        }
        
        // Auto-check on page load
        window.onload = function() {
            showResult('Ready to test! Database has been cleared of old data.', 'good');
        };
    </script>
</body>
</html>